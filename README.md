# OIC Environment Clone Scripts
These scripts provide a simplified way of running the import and export instance REST commands in OIC.
The also provide support for creating and deleting OCI instances using the OCI command line.
See the [OIC documentation] for details on import / export.
See the [OCI CLI OIC documentation] for details on creating and deleting OIC instances vi OCI CLI.
To use the create and delete scripts it is necessary to have the OCI CLI tools setup, see the [OCI documentation] for details.
If you are going to use the create script then it relies on [jq] which must be available on the system running the scripts.
The test scripts also use [jq].
See the [OIC documentation] for details.

## Scripts
Following scripts are provided:

| Script | Description |
| ------: | ----------- |
| | CONFIG |
| [env.sh] | Used to query for parameters for scripts, also provides some common functions to retrieve and construct credentials and URLs.|
| [oic_env.sh] | Blank environment variables |
| | IMPORT / EXPORT |
| [export.sh] | Runs the OIC export environment command. |
| [exportStatus.sh] | Get the status of the export command. Takes a single parameter, the jobId returned from the export command. |
| [listBucket.sh] | List all the files in the object storage bucket. |
| [copyExport.sh] | Copy file from STORAGE bucket to REPLICA_STORAGE bucket. Takes a single parameter, the filename of the archive generated by the export command. This requires OCI CLI to have been set up. |  
| [objectStatus.sh] | Get the status of the copy . |  
| [import.sh] | Runs the import command. Takes a single parameter, the filename of the archive generated by the export command. An optional second parameter allows overriding the IMPORT_STATE. |
| [importStatus.sh] | Get the status of the import command. Takes a single parameter, the jobId returned from the import command. |
| | CREATE / DELETE |
| [createIntegration.sh] | Create a new OIC instance |
| [deleteIntegration.sh] | Delete an OIC instance |
| [getIntegration.sh] | Get OIC instance details |
| [getWorkRequest.sh] | Get status of work request |
| [listCompartments.sh] | List all OCI compartments |
| [listIntegrations.sh] | List instances in compartment |
| [listRegions.sh] | List OCI Regions |
| [testOCI.sh] | Tests for OCI scripts |



## [env.sh] File
If they are not provided then the scripts in [env.sh] will prompt for them.
Passwords/Secrets are not echoed to the screen when entered.

### Environment Variables
The following environment variables are set in the [env.sh] file.

| Property | Meaning | Used By |
| :------: | ------- | ------- |
| STORAGE_REGION | OCI Region | [import.sh], [export.sh], [listBucket.sh], [copyExport.sh] |
| STORAGE_TENANCY | OCI Tenancy | [import.sh], [export.sh], [listBucket.sh], [copyExport.sh] |
| STORAGE_BUCKET | OCI Object Storage Bucket | [import.sh], [export.sh], [listBucket.sh], [copyExport.sh] |
| STORAGE_USER | OCI Object Storage User (prefix with oracleidentitycloudservice/ if using IDCS federated user | [import.sh], [export.sh], [listBucket.sh], [copyExport.sh] |
| STORAGE_PASSWORD | [OCI Auth Token] | [import.sh], [export.sh], [listBucket.sh], [copyExport.sh] |
| REPLICA_STORAGE_REGION | OCI Region | [copyExport.sh] |
| REPLICA_STORAGE_TENANCY | OCI Tenancy | [copyExport.sh] |
| REPLICA_STORAGE_BUCKET | OCI Object Storage Bucket | [copyExport.sh] |
| REPLICA_STORAGE_USER | OCI Object Storage User (prefix with oracleidentitycloudservice/ if using IDCS federated user | [copyExport.sh] |
| REPLICA_STORAGE_PASSWORD | [OCI Auth Token] | [copyExport.sh] |
| SRC_OIC_HOST | Base URL of OIC Instance to be exported  Should be of the form https://oicinstance.integration.ocp.oraclecloud.com. | [export.sh] [exportStatus.sh] |
| SRC_OIC_USERNAME | IDCS Username with Admin Privileges | [export.sh] [exportStatus.sh] |
| SRC_OIC_PASSWORD | IDCS Password | [export.sh] [exportStatus.sh] |
| TGT_OIC_HOST | Base URL of OIC Instance to receive import  Should be of the form https://oicinstance.integration.ocp.oraclecloud.com. | [export.sh] [exportStatus.sh] |
| TGT_OIC_USERNAME | IDCS Username with Admin Privileges | [export.sh] [exportStatus.sh] |
| TGT_OIC_PASSWORD | IDCS Password | [import.sh] [importStatus.sh] |
| IMPORT_STATE / Status of Imported integrations.  Valid Values are :  | [import.sh] |
| CURL_FLAGS | Flags passed to curl command | [import.sh], [importStatus.sh], [listBucket.sh], [export.sh], [exportStatus.sh] |
| INTEGRATION_ID | OCID of Integration Instance | [getIntegration.sh], [deleteIntegration.sh], [getIntegration.sh], [getWorkRequest.sh] |
| COMPARTMENT_ID | OCID of Compartment | [createIntegration.sh], [listIntegrations.sh] |
| REGION | OCI Region | [createIntegration.sh], [deleteIntegration.sh], [getIntegration.sh], [getWorkRequest.sh], [listIntegrations.sh] |
| DISPLAY_NAME | Name of New OIC Instance | [createIntegration.sh] |
| IS_BYOL | BYOL Flag for OIC (true or false) | [createIntegration.sh] |
| MESSAGE_PACKS | Number of Message Packs for OIC | [createIntegration.sh] |
| TYPE | OIC Edition (ENTERPRISE or STANDARD) | [createIntegration.sh] |
| IDCS_URL | IDCS host (https://idcs-hostname) | [createIntegration.sh] |
| IDCS_CLIENT_ID | OAuth Client ID | [createIntegration.sh] |
| IDCS_CLIENT_SECRET | OAuth Client Secret | [createIntegration.sh] |
| IDCS_USERNAME | IDCS Username | [createIntegration.sh] |
| IDCS_PASSWORD | IDCS Password | [createIntegration.sh] |
| WORK_REQUEST_ID | Work Request ID from Delete & Create Operations | [getWorkRequest.sh] |


#### CURL_FLAGS Explained
The CURL_FLAGS are applied to all REST calls and allow additional information to be output.  Flags that have been verified to work are:
* -v
    * Verbose output, including SSL handshake
* -k
    * Ignore certification validation errors - should not be necessary
* -w HTTP_STATUS=%{http_code}
    * Output the HTTP Status returned from the command.  Useful in debugging.

## Example Exporting from an OIC Instance
Run the export command:
```shell script
./export.sh
```
> {"jobId":"142040","location":"https://swiftobjectstorage.eu-frankfurt-1.oraclecloud.com/v1/xxxxxx/migrationBucket","status":"NOT_STARTED"}

Check the status of the export command:
```shell script
./exportStatus.sh 142040
```
> {"jobId":"142040","jobType":"EXPORT","includeSecurityArtifacts":true,"overallStatus":"RUNNING","startTime":"Thu May 14 21:28:31 UTC 2020","components":[{"name":"Integration","status":"NOT_STARTED"},{"name":"Process","status":"NOT_STARTED"}]}

Check it again:
```shell script
./exportStatus.sh 142040
```
> {"jobId":"142040","jobType":"EXPORT","archiveName":"Local_Suite_Instance-142040.zip","includeSecurityArtifacts":true,"overallStatus":"COMPLETED","startTime":"Thu May 14 21:28:31 UTC 2020","endTime":"Thu May 14 21:55:57 UTC 2020","components":[{"name":"Integration","status":"COMPLETED","percentage":100},{"name":"Process","status":"COMPLETED","percentage":100}]}

List files in OCI Bucket to make sure that it is there:
```shell script
./listBucket.sh
```
> [{"name":"Local_Suite_Instance-142040.zip","hash":"8c1c0866ff0e7ff78441bc45cded6dfc","bytes":29688003,"last_modified":"2020-05-14T21:56:02.716000","content_type":null}]

## Example Importing to an OIC Instance
Run the import command:
```shell script
./import.sh Local_Suite_Instance-142040.zip
```
> {"jobId":"1231","status":"NOT_STARTED"}

Check the status of the import command:
```shell script
./importStatus.sh 1231
```
> {"jobId":"1231","jobType":"IMPORT","includeSecurityArtifacts":true,"overallStatus":"RUNNING","startTime":"Thu May 14 22:18:02 UTC 2020","mode":"ImportOnly","importScheduleParams":false,"startSchedules":false,"components":[{"name":"Integration","status":"NOT_STARTED"},{"name":"Process","status":"NOT_STARTED"}]}

Check it again:
```shell script
./importStatus.sh 1231
```
> {"jobId":"1231","jobType":"IMPORT","includeSecurityArtifacts":true,"overallStatus":"RUNNING","startTime":"Thu May 14 22:18:02 UTC 2020","mode":"ImportOnly","importScheduleParams":false,"startSchedules":false,"components":[{"name":"Integration","status":"RUNNING"},{"name":"Process","status":"CANCELLED"}]}

## Example Moving Archive Between Buckets
Run the copy command:
```shell script
./copyExport.sh Local_Suite_Instance-329120.zip
```
>   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
>                                  Dload  Upload   Total   Spent    Left  Speed
> 100 7921k  100 7921k    0     0  1214k      0  0:00:06  0:00:06 --:--:-- 1550k
> 
> HTTP_STATUS=200
> 
> HTTP_STATUS=201

Check the file is in the target storage area:
```shell script
./listBucket.sh
```
> [{"name":"Local_Suite_Instance-329120.zip","hash":"48c481aeccdf0497d52f1e03f2fa783b","bytes":8111217,"last_modified":"2020-05-19T20:26:03.958000","content_type":null}]

[OIC Documentation]: https://docs.oracle.com/en/cloud/paas/integration-cloud/integration-cloud-auton/export-integration-and-process-design-time-metadata-instances.html
[OCI Auth Token]: https://docs.cloud.oracle.com/en-us/iaas/Content/Identity/Tasks/managingcredentials.htm#Working
[OCI documentation]: https://docs.cloud.oracle.com/en-us/iaas/Content/API/SDKDocs/cliinstall.htm
[OCI CLI OIC documentation]: https://docs.cloud.oracle.com/en-us/iaas/tools/oci-cli/latest/oci_cli_docs/cmdref/integration.html
[jq]: https://stedolan.github.io/jq/download/
[env.sh]: env.sh
[export.sh]: export.sh
[exportStatus.sh]: exportStatus.sh
[import.sh]: import.sh
[importStatus.sh]: importStatus.sh
[listBucket.sh]: listBucket.sh
[copyExport.sh]: copyExport.sh
[copyStatus.sh]: copyStatus.sh
[createIntegration.sh]: createIntegration.sh
[deleteIntegration.sh]: deleteIntegration.sh
[getIntegration.sh]: getIntegration.sh
[getWorkRequest.sh]: getWorkRequest.sh
[listCompartments.sh]: listCompartments.sh
[listIntegrations.sh]: listIntegrations.sh
[listRegions.sh]: listRegions.sh
[testOCI.sh]: testOCI.sh
