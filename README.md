# OIC Environment Clone Scripts
These scripts provide a simplified way of running the import and export instance REST commands in OIC.
See the [OIC documentation] for details.

## Scripts
Following scripts are provided:

| Script | Description |
| ------: | ----------- |
| [env.sh] | Used to set parameters for scripts, also provides some common functions to retrieve and construct credentials and URLs. This script is not called directly but can be used to configure the endpoints and is called by other scripts.|
| [export.sh] | Runs the export command. |
| [export_status.sh] | Get the status of the export command. Takes a single parameter, the jobId returned from the export command. |
| [list_bucket.sh] | List all the files in the object storage bucket. |  
| [copy_export.sh] | Copy file from STORAGE bucket to REPLICA_STORAGE bucket. Takes a single parameter, the filename of the archive generated by the export command. |  
| [import.sh] | Runs the import command. Takes a single parameter, the filename of the archive generated by the export command. An optional second parameter allows overriding the IMPORT_STATE. |
| [import_status.sh] | Get the status of the import command. Takes a single parameter, the jobId returned from the import command. | 

## [env.sh] File
The env.sh file can be used to provide values for OIC systems, Storage system and appropriate credentials for each.
If they are not provided in the env.sh then the scripts will prompt for them.
Passwords/Secrets are not echoed to the screen when entered.

### Environment Variables
The following environment variables are set in the [env.sh] file.

| Property | Meaning | Used By |
| :------: | ------- | ------- |
| STORAGE_REGION | OCI Region | [import.sh], [export.sh], [list_bucket.sh], [copy_export.sh] |
| STORAGE_TENANCY | OCI Tenancy | [import.sh], [export.sh], [list_bucket.sh], [copy_export.sh] |
| STORAGE_BUCKET | OCI Object Storage Bucket | [import.sh], [export.sh], [list_bucket.sh], [copy_export.sh] |
| STORAGE_USER | OCI Object Storage User (prefix with oracleidentitycloudservice/ if using IDCS federated user | [import.sh], [export.sh], [list_bucket.sh], [copy_export.sh] |
| STORAGE_PASSWORD | [OCI Auth Token] | [import.sh], [export.sh], [list_bucket.sh], [copy_export.sh] |
| REPLICA_STORAGE_REGION | OCI Region | [copy_export.sh] |
| REPLICA_STORAGE_TENANCY | OCI Tenancy | [copy_export.sh] |
| REPLICA_STORAGE_BUCKET | OCI Object Storage Bucket | [copy_export.sh] |
| REPLICA_STORAGE_USER | OCI Object Storage User (prefix with oracleidentitycloudservice/ if using IDCS federated user | [copy_export.sh] |
| REPLICA_STORAGE_PASSWORD | [OCI Auth Token] | [copy_export.sh] |
| SRC_OIC_HOST | Base URL of OIC Instance to be exported  Should be of the form https://oicinstance.integration.ocp.oraclecloud.com. | [export.sh] [export_status.sh] |
| SRC_OIC_USERNAME | IDCS Username with Admin Privileges | [export.sh] [export_status.sh] |
| SRC_OIC_PASSWORD | IDCS Password | [export.sh] [export_status.sh] |
| TGT_OIC_HOST | Base URL of OIC Instance to receive import  Should be of the form https://oicinstance.integration.ocp.oraclecloud.com. | [export.sh] [export_status.sh] |
| TGT_OIC_USERNAME | IDCS Username with Admin Privileges | [export.sh] [export_status.sh] |
| TGT_OIC_PASSWORD | IDCS Password | [import.sh] [import_status.sh] |
| IMPORT_STATE / Status of Imported integrations.  Valid Values are :  | [import.sh] |
| CURL_FLAGS | Flags passed to curl command | [import.sh], [import_status.sh], [list_bucket.sh], [export.sh], [export_status.sh] |

#### CURL_FLAGS Explained
The CURL_FLAGS are applied to all REST calls and allow additional information to be output.  Flags that have been verified to work are:
* -v
    * Verbose output, including SSL handshake
* -k
    * Ignore certification validation errors - should not be necessary
* -w HTTP_STATUS=%{http_code}
    * Output the HTTP Status returned from the command.  Useful in debugging.

## Example Exporting from an OIC Instance
Run the export command:
```shell script
./export.sh
```
> {"jobId":"142040","location":"https://swiftobjectstorage.eu-frankfurt-1.oraclecloud.com/v1/xxxxxx/migrationBucket","status":"NOT_STARTED"}

Check the status of the export command:
```shell script
./export_status.sh 142040
```
> {"jobId":"142040","jobType":"EXPORT","includeSecurityArtifacts":true,"overallStatus":"RUNNING","startTime":"Thu May 14 21:28:31 UTC 2020","components":[{"name":"Integration","status":"NOT_STARTED"},{"name":"Process","status":"NOT_STARTED"}]}

Check it again:
```shell script
./export_status.sh 142040
```
> {"jobId":"142040","jobType":"EXPORT","archiveName":"Local_Suite_Instance-142040.zip","includeSecurityArtifacts":true,"overallStatus":"COMPLETED","startTime":"Thu May 14 21:28:31 UTC 2020","endTime":"Thu May 14 21:55:57 UTC 2020","components":[{"name":"Integration","status":"COMPLETED","percentage":100},{"name":"Process","status":"COMPLETED","percentage":100}]}

List files in OCI Bucket to make sure that it is there:
```shell script
./list_bucket.sh
```
> [{"name":"Local_Suite_Instance-142040.zip","hash":"8c1c0866ff0e7ff78441bc45cded6dfc","bytes":29688003,"last_modified":"2020-05-14T21:56:02.716000","content_type":null}]

## Example Importing to an OIC Instance
Run the import command:
```shell script
./import.sh Local_Suite_Instance-142040.zip
```
> {"jobId":"1231","status":"NOT_STARTED"}

Check the status of the import command:
```shell script
./import_status.sh 1231
```
> {"jobId":"1231","jobType":"IMPORT","includeSecurityArtifacts":true,"overallStatus":"RUNNING","startTime":"Thu May 14 22:18:02 UTC 2020","mode":"ImportOnly","importScheduleParams":false,"startSchedules":false,"components":[{"name":"Integration","status":"NOT_STARTED"},{"name":"Process","status":"NOT_STARTED"}]}

Check it again:
```shell script
./import_status.sh 1231
```
> {"jobId":"1231","jobType":"IMPORT","includeSecurityArtifacts":true,"overallStatus":"RUNNING","startTime":"Thu May 14 22:18:02 UTC 2020","mode":"ImportOnly","importScheduleParams":false,"startSchedules":false,"components":[{"name":"Integration","status":"RUNNING"},{"name":"Process","status":"CANCELLED"}]}

## Example Moving Archive Between Buckets
Run the copy command:
```shell script
./copy_export.sh Local_Suite_Instance-329120.zip
```
>   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
>                                  Dload  Upload   Total   Spent    Left  Speed
> 100 7921k  100 7921k    0     0  1214k      0  0:00:06  0:00:06 --:--:-- 1550k
> 
> HTTP_STATUS=200
> 
> HTTP_STATUS=201

Check the file is in the target storage area:
```shell script
./list_bucket.sh
```
> [{"name":"Local_Suite_Instance-329120.zip","hash":"48c481aeccdf0497d52f1e03f2fa783b","bytes":8111217,"last_modified":"2020-05-19T20:26:03.958000","content_type":null}]

[OIC Documentation]: https://docs.oracle.com/en/cloud/paas/integration-cloud/integration-cloud-auton/export-integration-and-process-design-time-metadata-instances.html
[OCI Auth Token]: https://docs.cloud.oracle.com/en-us/iaas/Content/Identity/Tasks/managingcredentials.htm#Working
[env.sh]: env.sh
[export.sh]: export.sh
[export_status.sh]: export_status.sh
[import.sh]: import.sh
[import_status.sh]: import_status.sh
[list_bucket.sh]: list_bucket.sh
[copy_export.sh]: copy_export.sh